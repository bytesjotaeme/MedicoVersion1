{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Turno - Cl√≠nica Camino al Cielo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'pacientes/css/public_style.css' %}">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="{% url 'homepage' %}">
                üè• **Cl√≠nica Camino al Cielo**
            </a>
            <a href="{% url 'solicitar_turno' %}" class="btn btn-primary d-lg-none">Solicitar Turno</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'homepage' %}">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">La Cl√≠nica</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Servicios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contacto</a>
                    </li>
                    <li class="nav-item d-none d-lg-block ms-3">
                        <a href="{% url 'solicitar_turno' %}" class="btn btn-primary">Solicitar Turno</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero-section-small text-center text-white d-flex align-items-center justify-content-center">
        <div class="container">
            <h1 class="display-5">Agenda tu Consulta</h1>
            <p class="lead">Elige al profesional y el horario que mejor se adapte a ti.</p>
        </div>
    </div>

    <div class="container my-5">
        <div class="card p-4 shadow-lg" style="max-width: 800px; margin: auto;">
            <h2 class="text-center mb-4">Solicitar Turno</h2>
            <form method="post" id="turnoForm">
                {% csrf_token %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_doctor" class="form-label">Doctor <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_doctor" name="doctor" required>
                            <option value="">Seleccione un doctor...</option>
                            {% for doctor in doctores %}
                                <option value="{{ doctor.id }}">{{ doctor.nombre }} {{ doctor.apellido }} ({{ doctor.especialidad }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="id_servicio" class="form-label">Tipo de Consulta <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_servicio" name="servicio" required>
                            <option value="">Seleccione un servicio...</option>
                            {% for servicio in servicios %}
                                <option value="{{ servicio.id }}">{{ servicio.nombre }} ({{ servicio.duracion_minutos }} min)</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_fecha" class="form-label">Fecha <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="id_fecha" name="fecha" required>
                    </div>
                    <div class="col-md-6">
                        <label for="id_hora" class="form-label">Hora <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_hora" name="hora" required disabled>
                            <option value="">Seleccione una fecha primero...</option>
                        </select>
                        <div id="hora_feedback" class="form-text text-muted"></div>
                    </div>
                </div>

                <h5 class="mt-4 mb-3">Datos del Paciente</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="id_nombre" name="nombre" required>
                    </div>
                    <div class="col-md-6">
                        <label for="id_apellido" class="form-label">Apellido <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="id_apellido" name="apellido" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_dni" class="form-label">DNI <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="id_dni" name="dni" required>
                    </div>
                    <div class="col-md-6">
                        <label for="id_telefono" class="form-label">Tel√©fono</label>
                        <input type="tel" class="form-control" id="id_telefono" name="telefono">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="id_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="id_email" name="email">
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg mt-3">Confirmar Turno</button>
                    <a href="{% url 'homepage' %}" class="btn btn-outline-secondary mt-2">Volver al Inicio</a>
                </div>
            </form>
        </div>
    </div>

    <footer class="footer-dark text-white pt-5 pb-4">
        <div class="container text-center text-md-start">
            <div class="row text-center text-md-start">
                <div class="col-md-3 col-lg-3 col-xl-3 mx-auto mt-3">
                    <h5 class="text-uppercase mb-4 fw-bold text-primary">Cl√≠nica Camino al Cielo</h5>
                    <p>Cuidamos de ti y tu familia con la mejor atenci√≥n profesional y humana.</p>
                </div>
                <div class="col-md-4 col-lg-3 col-xl-3 mx-auto mt-3">
                    <h5 class="text-uppercase mb-4 fw-bold text-primary">Contacto</h5>
                    <p><i class="bi bi-telephone-fill"></i> (381) 424-7610 - Recepci√≥n</p>
                    <p><i class="bi bi-whatsapp"></i> (381) 244-4000 - WP Recepci√≥n</p>
                    <p><i class="bi bi-geo-alt-fill"></i> Las Heras 575, San Miguel de Tucum√°n</p>
                </div>
                <div class="col-md-3 col-lg-2 col-xl-2 mx-auto mt-3">
                    <h5 class="text-uppercase mb-4 fw-bold text-primary">Redes Sociales</h5>
                    <a href="#" class="btn btn-outline-light btn-floating m-1"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="btn btn-outline-light btn-floating m-1"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="btn btn-outline-light btn-floating m-1"><i class="bi bi-youtube"></i></a>
                </div>
            </div>
            <hr class="mb-4">
            <div class="text-center">
                <p>Copyright ¬©2025 - Cl√≠nica Camino al Cielo, Todos los Derechos Reservados.</p>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const doctorSelect = document.getElementById('id_doctor');
            const servicioSelect = document.getElementById('id_servicio');
            const fechaInput = document.getElementById('id_fecha');
            const horaSelect = document.getElementById('id_hora');
            const horaFeedback = document.getElementById('hora_feedback');

            function cargarHorasDisponibles() {
                const doctorId = doctorSelect.value;
                const servicioId = servicioSelect.value;
                const fecha = fechaInput.value;

                horaSelect.innerHTML = '<option value="">Cargando horarios...</option>';
                horaSelect.disabled = true;
                horaFeedback.textContent = '';

                if (doctorId && servicioId && fecha) {
                    fetch(`/api/disponibilidad/?doctor_id=${doctorId}&servicio_id=${servicioId}&fecha=${fecha}`)
                        .then(response => response.json())
                        .then(data => {
                            horaSelect.innerHTML = '';
                            if (data.length > 0) {
                                data.forEach(hora => {
                                    const option = document.createElement('option');
                                    option.value = hora;
                                    option.textContent = hora;
                                    horaSelect.appendChild(option);
                                });
                                horaSelect.disabled = false;
                                horaFeedback.textContent = 'Horarios disponibles.';
                            } else {
                                horaSelect.innerHTML = '<option value="">No hay horarios disponibles para esta fecha.</option>';
                                horaFeedback.textContent = 'No se encontraron horarios para la fecha y servicio seleccionados.';
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar la disponibilidad:', error);
                            horaSelect.innerHTML = '<option value="">Error al cargar horarios.</option>';
                            horaFeedback.textContent = 'Error al cargar los horarios. Intente de nuevo.';
                        });
                } else {
                    horaSelect.innerHTML = '<option value="">Seleccione doctor, servicio y fecha.</option>';
                    horaSelect.disabled = true;
                    horaFeedback.textContent = 'Por favor, complete los campos anteriores para ver la disponibilidad.';
                }
            }

            doctorSelect.addEventListener('change', cargarHorasDisponibles);
            servicioSelect.addEventListener('change', cargarHorasDisponibles);
            fechaInput.addEventListener('change', cargarHorasDisponibles);
            
            // Establecer la fecha m√≠nima en el input de fecha
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0
            const dd = String(today.getDate()).padStart(2, '0');
            fechaInput.min = `${yyyy}-${mm}-${dd}`;

            // Cargar horas al inicio si ya hay valores (√∫til si el navegador guarda los datos)
            cargarHorasDisponibles();
        });
    </script>
</body>
</html>